html
	{% set validphotopath = False %}
	{% set rootphotofolder = '/photo' %}
	is_index = request.path.strip('/')=='album' or request.path.startswith('/album/page')
	head
		if is_index
			title= '照片库'
		else
			title= folder.title or site.title
		load("pure /template/css/album.scss")
		if not is_index
			load("fonts jquery#1.8.1 knockout")
			load('http://maps.google.com/maps/api/js?sensor=true')
			load("/template/js/gmaps.js /template/js/album.js")
	body
		if is_index
			.body_wrap
				h1 照片库
				.home
					a(href="/") 主页
				ul.albums.pure-g-r
					{% set onepagephotofolder = 6 %}
					if request.path.strip('/')=='album'
						a_root_photo = get_data(path=rootphotofolder,types='image', min_images_count=1, level=1, limit=1, with_page=False)
						if a_root_photo
							{% set onepagephotofolder = 5 %}
							li.album.pure-u-1-3
								a(href="/album/~root")
									.img_container
										img(src="{{a_root_photo.url}}?width=120&height=120&fixed=true")
									span.title= "照片根目录"
					for album in get_data(path=rootphotofolder,types='folder', min_images_count=1, level=1, limit=3)
						li.album.pure-u-1-3
							a(href='/album/{{album.path}}')
								.img_container
									img(src="{{album.url}}?width=120&height=120&fixed=true")
								span.title= album.title
				include include/paginator.jade
		else
			//for album viewer
			if request.path.startswith('/album/~root')
				{% set validphotopath = True %}
				sub_images = get_data(path=rootphotofolder,types='image', min_images_count=1, level=1, limit=6, pager_name='this_album', sort='asc')
				+bread_nav('/~root', prefix='/album', prefix_name='照片库>', split_by='>')			
			else
				if request.path.startswith('/album'+rootphotofolder)
					if folder.path.starswith('photo')
						{% set validphotopath = True %}
						if get_doc(path=path2)==None
							{% set validphotopath = False %}
							raise_404()		
						if get_data(types='folder+image', path=folder.path, min_images_count=1, level=1,return_count=True)==0
							raise_404()
						sub_images = get_data(types='folder+image', path=folder.path, min_images_count=1, level=1, limit=6, pager_name='this_album', sort='asc')
						+bread_nav(folder.path, prefix='/album', prefix_name='照片库>', split_by='>')
					else
						raise_404()		
				else
					{% set validphotopath = False %}
					raise_404()
			
			if validphotopath
				.boxes.pure-g-r
					.home
						a(href="/") 主     页
					.map-box.pure-u-2-3
						.box-container
							#map

					for im in sub_images
						.photo-box.pure-u-1-3
							.box-container
								if im.content_type == 'folder'
									a(href='/album/{{im.path}}')
										img(src="{{ im.url }}?width=320&height=214&fixed=true", alt=im.title)
										.caption
											span= im.title
											span (
											small=im.images_count
											span )
								else
									a.fb-image(href="#")
										img(src="{{ im.url }}?width=320&height=214&fixed=true", alt=im.title)
										.caption
											b= im.title
											span.image-date= im.date.format('%Y-%m-%d %H:%M')

				paginator = get_paginator('this_album')
				include include/paginator.jade

				div(data-bind="visible: current_window(), template: {name: current_window()}")
				script#image-viewer(type='text/html')
					.image-viewer
						.wrap
							.head
								.caption(data-bind="text: current_image().title")
								.image-info(data-bind="visible:show_exif(),foreach:exif_list")
									span.exif-field
										span(data-bind="text:k")
										|:
                            			span(data-bind="text:v")
								.commands
									a(href="#", data-bind="click: show_full")
										i.fa.fa-external-link-square
									a(href="#", data-bind="visible:has_exif(),click: function(){show_exif(!show_exif())}") EXIF
									a(href="#", data-bind="click: function(){current_window(null)}")
										i.fa.fa-times-circle-o &nbsp;Close
							.connected
								a.pre(href="#", data-bind="click: pre, visible: has_pre()")
									i.fa.fa-arrow-left
								a.next(href="#", data-bind="click: next, visible: has_next()")
									i.fa.fa-arrow-right

							.body
								.image
									div(data-bind="click: next")
										img(data-bind="attr: {src: current_image().url, alt: current_image().title}", onload="$(this).addClass('loaded')")

				script(type="text/javascript")
					var images = {{ sub_images.json}};
					run_viewer(images);
            		draw_map(images);


		#footer
			.CopyRight_By
						span Powered by 
						a(target='_blank', href="http://www.farbox.com") FarBox
						span . Owned by 
						<mailto> dysdy@yahoo.com
						span . ©2014, All Right Reserved.
